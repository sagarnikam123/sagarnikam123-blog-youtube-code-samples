# Fluent Bit Configuration - Fuzzy Train Logs to Loki
#
# Collects logs generated by fuzzy-train and sends them to Loki
# Parses: JSON, logfmt, Apache Common log formats
#
# Usage:
#   fluent-bit -c fluent-bit-fuzzy-train-loki.yaml
#
# Prerequisites:
#   - Loki running on http://127.0.0.1:3100
#   - Log files generated by: generate-logs.sh
#
# Log files location: ${HOME}/data/log/logger/
#   - fuzzy-train-json.log      (JSON, 2 lines/sec)
#   - fuzzy-train-json-hv.log   (JSON high volume, 5 lines/sec)
#   - fuzzy-train-logfmt.log    (logfmt, 1 line/sec)
#   - fuzzy-train-apache.log    (Apache Common, 3 lines/sec)
#
# Note: Uses ${HOME} system env variable for portable paths

# =============================================================================
# Service Configuration
# =============================================================================
service:
  flush: 1
  grace: 5
  log_level: info
  http_server: true
  http_listen: 0.0.0.0
  http_port: 2020

# =============================================================================
# Parsers
# =============================================================================
parsers:
  # JSON parser
  - name: json_parser
    format: json
    time_key: timestamp
    time_format: "%Y-%m-%dT%H:%M:%S.%L%z"

  # Logfmt parser
  - name: logfmt_parser
    format: logfmt

  # Apache Common Log Format parser
  - name: apache_parser
    format: regex
    regex: '^(?<host>[^ ]*) (?<ident>[^ ]*) (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +(?<protocol>\S*))?)?" (?<code>[^ ]*) (?<size>[^ ]*)'
    types: code:integer size:integer

# =============================================================================
# Pipeline
# =============================================================================
pipeline:
  inputs:
    # JSON logs
    - name: tail
      tag: json
      path: ${HOME}/data/log/logger/fuzzy-train-json.log
      parser: json_parser
      read_from_head: false
      db: /tmp/fluent-bit-json.db

    # JSON logs (high volume)
    - name: tail
      tag: json_hv
      path: ${HOME}/data/log/logger/fuzzy-train-json-hv.log
      parser: json_parser
      read_from_head: false
      db: /tmp/fluent-bit-json-hv.db

    # Logfmt logs
    - name: tail
      tag: logfmt
      path: ${HOME}/data/log/logger/fuzzy-train-logfmt.log
      parser: logfmt_parser
      read_from_head: false
      db: /tmp/fluent-bit-logfmt.db

    # Apache logs
    - name: tail
      tag: apache
      path: ${HOME}/data/log/logger/fuzzy-train-apache.log
      parser: apache_parser
      read_from_head: false
      db: /tmp/fluent-bit-apache.db

  outputs:
    - name: loki
      match: json*
      host: 127.0.0.1
      port: 3100
      labels: job=fluent-bit, format=json
      line_format: json

    - name: loki
      match: logfmt
      host: 127.0.0.1
      port: 3100
      labels: job=fluent-bit, format=logfmt
      line_format: json

    - name: loki
      match: apache
      host: 127.0.0.1
      port: 3100
      labels: job=fluent-bit, format=apache
      line_format: json

    # Debug output
    # - name: stdout
    #   match: "*"
    #   format: json_lines
