# Loki 3.6.x + AWS S3 + Thanos Objstore + memberlist
#
# =============================================================================
# CONFIGURATION SUMMARY
# =============================================================================
# Purpose: Multi-node ready configuration with AWS S3 using Thanos objstore
# Target: Single or multi-node with memberlist (gossip protocol)
#
# Core Features:
# • Target: all (monolithic mode)
# • Authentication: disabled
# • UI: enabled
# • Storage: AWS S3 via Thanos objstore client
# • Schema: v13 with TSDB store
# • KV Store: memberlist (ready for clustering)
#
# Prerequisites:
# • AWS S3 bucket created
# • AWS credentials configured (env vars, IAM role, or below)
# • Update bucket name and region below
#
# Use Cases:
# ✓ Production with AWS S3
# ✓ Multi-node clustering
# ✓ High availability setups
# ✗ Simple single-node (use inmemory variant)
# =============================================================================

auth_enabled: false

server:
  http_listen_address: 0.0.0.0
  http_listen_port: 3100
  grpc_listen_address: 0.0.0.0
  grpc_listen_port: 9095
  http_server_read_timeout: 10m
  http_server_write_timeout: 10m
  http_server_idle_timeout: 5m
  grpc_server_max_recv_msg_size: 41943040  # 40MB for clustering
  grpc_server_max_send_msg_size: 41943040
  grpc_server_max_concurrent_streams: 0
  log_level: warn

ui:
  enabled: true
  debug: true

distributor:
  ring:
    kvstore:
      store: memberlist
    heartbeat_period: 5s
  push_worker_count: 512

querier:
  tail_max_duration: 12h
  query_ingesters_within: 3h
  max_concurrent: 4

query_scheduler:
  max_outstanding_requests_per_tenant: 64000
  grpc_client_config:
    max_recv_msg_size: 209715200
    max_send_msg_size: 209715200
    grpc_compression: snappy
  use_scheduler_ring: true
  scheduler_ring:
    kvstore:
      store: memberlist
      prefix: collectors/

frontend:
  log_queries_longer_than: 60s
  query_stats_enabled: true
  max_outstanding_per_tenant: 8192
  grpc_client_config:
    max_recv_msg_size: 209715200
    max_send_msg_size: 209715200
    grpc_compression: snappy
  encoding: protobuf
  compress_responses: true

query_range:
  align_queries_with_step: true
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 300
        ttl: 1h
    compression: snappy
  cache_results: true
  max_retries: 15
  cache_index_stats_results: true
  index_stats_results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 300
        ttl: 1h
    compression: snappy
  cache_volume_results: true
  volume_results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 300
        ttl: 1h
    compression: snappy
  cache_instant_metric_results: true
  instant_metric_results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 300
        ttl: 1h
    compression: snappy
  cache_series_results: true
  series_results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 300
        ttl: 1h
    compression: snappy
  cache_label_results: true
  label_results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 300
        ttl: 1h
    compression: snappy

ruler:
  storage:
    type: local
    local:
      directory: /tmp/loki/rules
  rule_path: /tmp/loki/rules
  alertmanager_url: http://127.0.0.1:9093
  ring:
    kvstore:
      store: memberlist
  enable_api: true

ingester_client:
  pool_config:
    client_cleanup_period: 20s
    health_check_ingesters: false
    remote_timeout: 5s
  remote_timeout: 10s
  grpc_client_config:
    max_recv_msg_size: 209715200
    max_send_msg_size: 209715200
    grpc_compression: snappy

ingester:
  lifecycler:
    ring:
      kvstore:
        store: memberlist
        prefix: collectors/
      replication_factor: 1
    final_sleep: 0s
    heartbeat_timeout: 1m
    heartbeat_period: 5s
    min_ready_duration: 15s
  concurrent_flushes: 64
  flush_check_period: 30s
  chunk_retain_period: 30s
  chunk_idle_period: 30s
  chunk_block_size: 262144
  chunk_target_size: 1572864
  chunk_encoding: snappy
  max_chunk_age: 2h
  wal:
    enabled: true
    dir: /tmp/loki/wal

index_gateway:
  mode: ring
  ring:
    kvstore:
      store: memberlist
      prefix: collectors/

chunk_store_config:
  chunk_cache_config:
    embedded_cache:
      enabled: true
      max_size_mb: 300
      ttl: 1h

storage_config:
  index_cache_validity: 5m
  index_queries_cache_config:
    embedded_cache:
      enabled: true
      max_size_mb: 300
      ttl: 1h
  use_thanos_objstore: true
  tsdb_shipper:
    active_index_directory: /tmp/loki/tsdb-shipper-active
    cache_location: /tmp/loki/tsdb-shipper-cache
    cache_ttl: 24h

schema_config:
  configs:
    - from: 2024-01-01
      store: tsdb
      object_store: s3
      schema: v13
      index:
        prefix: index_
        period: 24h

compactor:
  working_directory: /tmp/loki/compactor
  compaction_interval: 5m
  retention_enabled: true
  retention_delete_delay: 1h
  retention_delete_worker_count: 150
  delete_request_store: s3
  delete_batch_size: 100
  max_compaction_parallelism: 2
  compactor_ring:
    kvstore:
      store: memberlist
      prefix: collectors/
  tables_to_compact: 2

compactor_grpc_client:
  max_recv_msg_size: 209715200
  max_send_msg_size: 209715200
  grpc_compression: snappy

limits_config:
  ingestion_rate_mb: 500
  ingestion_burst_size_mb: 1000
  max_label_name_length: 1024
  max_label_value_length: 5120
  reject_old_samples: true
  reject_old_samples_max_age: 168h
  max_line_size: 16MB
  max_global_streams_per_user: 100000
  per_stream_rate_limit: 20MB
  per_stream_rate_limit_burst: 40MB
  max_query_parallelism: 64
  tsdb_max_query_parallelism: 32
  max_entries_limit_per_query: 10000
  split_queries_by_interval: 6h
  retention_period: 168h
  allow_structured_metadata: true
  volume_enabled: true

frontend_worker:
  grpc_client_config:
    max_recv_msg_size: 209715200
    max_send_msg_size: 209715200
    grpc_compression: snappy

memberlist:
  node_name: ${HOSTNAME:-"loki-1"}
  bind_addr: [0.0.0.0]
  bind_port: 7946
  gossip_interval: 200ms
  gossip_nodes: 3
  compression_enabled: true
  advertise_port: 7946

analytics:
  reporting_enabled: false

# =============================================================================
# AWS S3 Configuration (Thanos Objstore)
# =============================================================================
# Update these values for your AWS environment:
#   - bucket_name: your S3 bucket
#   - region: your AWS region
#   - access_key_id/secret_access_key: or use IAM role/instance profile
# =============================================================================
common:
  path_prefix: /tmp/loki
  storage:
    object_store:
      s3:
        endpoint: s3.us-east-1.amazonaws.com  # Change to your region
        region: us-east-1                      # Change to your region
        bucket_name: my-loki-bucket            # Change to your bucket
        access_key_id: ""                      # Set or use IAM role
        secret_access_key: ""                  # Set or use IAM role
        insecure: false
  persist_tokens: false
  replication_factor: 1
  ring:
    kvstore:
      store: memberlist
    heartbeat_period: 15s
    heartbeat_timeout: 1m
    num_tokens: 256
    replication_factor: 1
