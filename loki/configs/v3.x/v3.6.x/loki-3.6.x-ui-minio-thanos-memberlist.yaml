# Loki 3.6.x + MinIO (Thanos Object Store) + memberlist
#
# =============================================================================
# CONFIGURATION SUMMARY
# =============================================================================
# Purpose: Production-like config with Thanos object store backend
# Target: Single-node with memberlist (ready for multi-node)
#
# Core Features:
# • Target: all (monolithic mode)
# • Authentication: disabled
# • UI: enabled with debug mode
# • Storage: MinIO via Thanos object store (use_thanos_objstore: true)
# • Schema: v13 with TSDB store
# • KV Store: memberlist (gossip protocol)
#
# Key Difference from loki-3.6.x-ui-minio-memberlist.yaml:
# • Uses Thanos object store config format (storage_config.object_store.s3)
# • More explicit S3 configuration options
# • Better suited for production S3/MinIO setups
#
# Prerequisites:
# • MinIO running on 127.0.0.1:9000
# • Bucket: loki-chunks (create before starting)
#
# Use Cases:
# ✓ Production-like development with Thanos object store
# ✓ Testing memberlist clustering
# ✓ Learning Thanos object store configuration
# ✗ True production (use external S3/MinIO)
# =============================================================================

auth_enabled: false

server:
  http_listen_address: 127.0.0.1
  http_listen_port: 3100
  grpc_listen_address: 127.0.0.1
  grpc_listen_port: 9095
  grpc_server_max_concurrent_streams: 0
  grpc_server_keepalive_time: 30s
  grpc_server_keepalive_timeout: 5s
  report_grpc_codes_in_instrumentation_label_enabled: true
  log_format: logfmt
  log_level: warn

ui:
  enabled: true
  debug: true

distributor:
  ring:
    kvstore:
      store: memberlist
    heartbeat_period: 5s
    heartbeat_timeout: 1m
    instance_id: ${HOSTNAME:-"loki-distributor"}
    instance_port: 9095
    instance_addr: 127.0.0.1

querier:
  query_ingesters_within: 3h
  max_concurrent: 4

query_scheduler:
  grpc_client_config:
    grpc_compression: snappy
    connect_timeout: 5s
  use_scheduler_ring: false
  scheduler_ring:
    kvstore:
      store: memberlist
    heartbeat_period: 15s
    heartbeat_timeout: 1m
    instance_id: ${HOSTNAME:-"loki-query_scheduler"}
    instance_port: 9095
    instance_addr: 127.0.0.1

frontend:
  query_stats_enabled: true
  grpc_client_config:
    grpc_compression: snappy
    connect_timeout: 5s
  address: 127.0.0.1
  port: 9095
  encoding: protobuf
  compress_responses: true

query_range:
  align_queries_with_step: true
  results_cache:
    cache:
      default_validity: 1h
      embedded_cache:
        enabled: true
    compression: snappy
  cache_results: true
  max_retries: 5
  cache_index_stats_results: true
  index_stats_results_cache:
    cache:
      default_validity: 1h
      embedded_cache:
        enabled: true
    compression: snappy
  cache_volume_results: true
  volume_results_cache:
    cache:
      default_validity: 1h
      embedded_cache:
        enabled: true
    compression: snappy
  cache_instant_metric_results: true
  instant_metric_results_cache:
    cache:
      default_validity: 1h
      embedded_cache:
        enabled: true
    compression: snappy
  cache_series_results: true
  series_results_cache:
    cache:
      default_validity: 1h
      embedded_cache:
        enabled: true
    compression: snappy
  cache_label_results: true
  label_results_cache:
    cache:
      default_validity: 1h
      embedded_cache:
        enabled: true
    compression: snappy

ruler:
  ruler_client:
    grpc_compression: snappy
    connect_timeout: 5s
  evaluation_interval: 1m
  poll_interval: 1m
  rule_path: /tmp/loki/rules
  alertmanager_url: http://127.0.0.1:9093
  ring:
    kvstore:
      store: memberlist
    heartbeat_period: 5s
    heartbeat_timeout: 1m
    instance_id: ${HOSTNAME:-"loki-ruler"}
    instance_port: 9095
    instance_addr: 127.0.0.1
    num_tokens: 128
  enable_api: true
  query_stats_enabled: true
  wal:
    dir: /tmp/loki/ruler-wal

ruler_storage:
  s3:
    endpoint: 127.0.0.1:9000
    bucket_name: loki-chunks
    secret_access_key: minioadmin
    access_key_id: minioadmin
    insecure: true
    bucket_lookup_type: auto
  backend: s3

ingester_client:
  pool_config:
    health_check_ingesters: false
    remote_timeout: 5s
  remote_timeout: 5s
  grpc_client_config:
    grpc_compression: snappy
    connect_timeout: 5s

ingester:
  lifecycler:
    ring:
      kvstore:
        store: memberlist
      heartbeat_timeout: 1m
      replication_factor: 1
    num_tokens: 128
    heartbeat_period: 5s
    heartbeat_timeout: 1m
    join_after: 0s
    min_ready_duration: 15s
    readiness_check_ring_health: true
    address: 127.0.0.1
    port: 9095
    id: ${HOSTNAME:-"loki-ingester"}
  chunk_retain_period: 0s
  chunk_idle_period: 30m
  chunk_block_size: 262144
  chunk_target_size: 1572864
  chunk_encoding: snappy
  max_chunk_age: 2h
  autoforget_unhealthy: false
  sync_period: 1h
  wal:
    dir: /tmp/loki/wal

pattern_ingester:
  enabled: false
  lifecycler:
    ring:
      kvstore:
        store: memberlist
      heartbeat_timeout: 1m
      replication_factor: 1
    num_tokens: 128
    heartbeat_period: 5s
    heartbeat_timeout: 1m
    min_ready_duration: 15s
    address: 127.0.0.1
    port: 9095
    id: ${HOSTNAME:-"loki-pattern_ingester"}

index_gateway:
  mode: simple
  ring:
    kvstore:
      store: memberlist
    heartbeat_period: 15s
    heartbeat_timeout: 1m
    num_tokens: 128
    replication_factor: 1
    instance_id: ${HOSTNAME:-"loki-index_gateway"}
    instance_port: 9095
    instance_addr: 127.0.0.1

bloom_build:
  enabled: false

bloom_gateway:
  enabled: false

# Thanos object store configuration
storage_config:
  index_cache_validity: 5m
  use_thanos_objstore: true
  object_store:
    s3:
      endpoint: 127.0.0.1:9000
      bucket_name: loki-chunks
      secret_access_key: minioadmin
      access_key_id: minioadmin
      insecure: true
      bucket_lookup_type: auto
  max_chunk_batch_size: 50
  tsdb_shipper:
    active_index_directory: /tmp/loki/tsdb-shipper-active
    cache_location: /tmp/loki/tsdb-shipper-cache
    cache_ttl: 24h
    index_gateway_client:
      grpc_client_config:
        grpc_compression: snappy
        connect_timeout: 5s
      server_address: 127.0.0.1:9095
    ingestername: ${HOSTNAME:-"loki-storage_config"}
  bloom_shipper:
    working_directory: /tmp/loki/blooms
    metas_cache:
      embedded_cache:
        enabled: true
    metas_lru_cache:
      enabled: true

chunk_store_config:
  chunk_cache_config:
    default_validity: 1h
    embedded_cache:
      enabled: true
  chunk_cache_config_l2:
    default_validity: 1h
    embedded_cache:
      enabled: true

schema_config:
  configs:
    - from: 2024-01-01
      store: tsdb
      object_store: s3
      schema: v13
      index:
        path_prefix: index/
        prefix: index_
        period: 24h
      chunks:
        prefix: chunks_
        period: 24h

compactor:
  working_directory: /tmp/loki/compactor
  compaction_interval: 10m
  retention_enabled: true
  retention_delete_delay: 2h
  delete_request_store: s3
  delete_request_store_key_prefix: index/
  delete_request_store_db_type: boltdb
  compactor_ring:
    kvstore:
      store: memberlist
    heartbeat_period: 15s
    heartbeat_timeout: 1m
    replication_factor: 1
    instance_id: ${HOSTNAME:-"loki-compactor"}
    instance_port: 9095
    instance_addr: 127.0.0.1
  tables_to_compact: 2
  skip_latest_n_tables: 0

compactor_grpc_client:
  grpc_compression: snappy
  connect_timeout: 5s

limits_config:
  ingestion_rate_strategy: local
  ingestion_rate_mb: 4
  ingestion_burst_size_mb: 6
  reject_old_samples: true
  reject_old_samples_max_age: 1w
  max_line_size: 256KB
  max_line_size_truncate: true
  increment_duplicate_timestamp: true
  discover_log_levels: true
  max_query_lookback: 168h
  max_query_length: 30d1h
  tsdb_precompute_chunks: true
  max_entries_limit_per_query: 5000
  query_timeout: 1m
  split_queries_by_interval: 1h
  volume_enabled: true
  retention_period: 168h
  bloom_gateway_enable_filtering: false
  bloom_creation_enabled: false

frontend_worker:
  frontend_address: 127.0.0.1:9095
  query_frontend_grpc_client:
    grpc_compression: snappy
    connect_timeout: 5s
  query_scheduler_grpc_client:
    grpc_compression: snappy
    connect_timeout: 5s

memberlist:
  node_name: ${HOSTNAME:-"loki-memberlist"}
  gossip_interval: 200ms
  gossip_nodes: 3
  compression_enabled: true
  advertise_addr: 127.0.0.1
  advertise_port: 7946
  join_members: []
  bind_addr: [127.0.0.1]
  bind_port: 7946

ingest_limits:
  enabled: false

tracing:
  enabled: false

analytics:
  reporting_enabled: false

common:
  path_prefix: /tmp/loki
  storage:
    object_store:
      s3:
        endpoint: 127.0.0.1:9000
        bucket_name: loki-chunks
        secret_access_key: minioadmin
        access_key_id: minioadmin
        insecure: true
        bucket_lookup_type: auto
  persist_tokens: false
  replication_factor: 1
  ring:
    kvstore:
      store: memberlist
      prefix: collectors/
    heartbeat_period: 15s
    heartbeat_timeout: 1m
    num_tokens: 128
    replication_factor: 1
    instance_id: ${HOSTNAME:-"loki-local-common"}
    instance_port: 9095
    instance_addr: 127.0.0.1
  instance_addr: 127.0.0.1
  compactor_address: 127.0.0.1:3100
  compactor_grpc_address: 127.0.0.1:9095
