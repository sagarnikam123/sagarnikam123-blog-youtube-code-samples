# Minikube Environment Values
# Fixes PV permission issues with hostpath provisioner
#
# Usage:
#   helm install prometheus prometheus-community/kube-prometheus-stack \
#     -n prometheus --create-namespace \
#     -f ../../base/values.yaml \
#     -f ../../versions/v3.5.0-lts/values.yaml \
#     -f values.yaml

# Disable noisy alerts not relevant for minikube/local dev
defaultRules:
  disabled:
    # Minikube VMs don't have NTP configured
    NodeClockNotSynchronising: true
    NodeClockSkewDetected: true
    # Watchdog is a dead man's switch - not needed for local dev
    Watchdog: true
    # These often fire on resource-constrained minikube
    KubeMemoryOvercommit: true
    KubeCPUOvercommit: true
    # etcd not accessible in minikube
    etcdHighNumberOfFailedGRPCRequests: true
    etcdMemberCommunicationSlow: true
    etcdNoLeader: true
    etcdHighFsyncDurations: true
    etcdHighCommitDurations: true
    etcdInsufficientMembers: true
    # Kubelet disabled - these will always fire
    KubeletDown: true
    KubeletTooManyPods: true
    # DaemonSet alerts - often noisy on single-node minikube
    KubeDaemonSetRolloutStuck: true
    KubeDaemonSetMisScheduled: true
    KubeDaemonSetNotScheduled: true
    # TargetDown - expected when components are disabled
    TargetDown: true

  # Uncomment below to completely remove rule groups (not just disable alerts)
  # This reduces rule count but removes recording rules too (may break dashboards)
  # rules:
  #   alertmanager: false
  #   configReloaders: false
  #   etcd: false
  #   general: false
  #   k8sContainerCpuUsageSecondsTotal: false
  #   k8sContainerMemoryCache: false
  #   k8sContainerMemoryRss: false
  #   k8sContainerMemorySwap: false
  #   k8sContainerMemoryWorkingSetBytes: false
  #   k8sContainerResource: false
  #   k8sPodOwner: false
  #   kubeApiserverAvailability: false
  #   kubeApiserverBurnrate: false
  #   kubeApiserverHistogram: false
  #   kubeApiserverSlos: false
  #   kubeControllerManager: false
  #   kubePrometheusGeneral: false
  #   kubePrometheusNodeRecording: false
  #   kubeProxy: false
  #   kubeSchedulerAlerting: false
  #   kubeSchedulerRecording: false
  #   kubeStateMetrics: false
  #   kubelet: false
  #   kubernetesApps: false
  #   kubernetesResources: false
  #   kubernetesStorage: false
  #   kubernetesSystem: false
  #   network: false
  #   node: false
  #   nodeExporterAlerting: false
  #   nodeExporterRecording: false
  #   prometheus: false
  #   prometheusOperator: false

prometheus:
  prometheusSpec:
    retention: 3d
    # Fix hostpath permission issues
    securityContext:
      runAsUser: 0
      runAsNonRoot: false
      fsGroup: 0
    # Container-level security context - disable readOnlyRootFilesystem
    containers:
      - name: prometheus
        securityContext:
          runAsUser: 0
          readOnlyRootFilesystem: false
          allowPrivilegeEscalation: false
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: 1
        memory: 1Gi
    # Disable persistent storage for minikube
    storageSpec:
      emptyDir:
        sizeLimit: 5Gi

alertmanager:
  alertmanagerSpec:
    retention: 24h
    securityContext:
      runAsUser: 0
      runAsNonRoot: false
      fsGroup: 0
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi

grafana:
  # Disable init-chown-data to avoid permission issues
  initChownData:
    enabled: false
  securityContext:
    runAsUser: 0
    runAsNonRoot: false
    fsGroup: 0
  # Use emptyDir for minikube testing
  persistence:
    enabled: false
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi
  # Minikube doesn't use serve_from_sub_path, so metrics at /metrics
  # (base values.yaml has /grafana/metrics for production with ingress)
  serviceMonitor:
    enabled: true
    path: /metrics

# Disable components not needed for local dev
kubeEtcd:
  enabled: false
kubeControllerManager:
  enabled: false
kubeScheduler:
  enabled: false
kubeProxy:
  enabled: false

# Disable API server scraping (job="apiserver")
kubeApiServer:
  enabled: false

# Disable CoreDNS scraping (job="coredns")
coreDns:
  enabled: false

# Disable kubelet scraping (job="kubelet", cadvisor, probes)
kubelet:
  enabled: false

# Disable kube-state-metrics (job="kube-state-metrics")
kube-state-metrics:
  enabled: false

# Disable prometheus-operator self-monitoring (job="prometheus-kube-prometheus-operator", config-reloader)
prometheusOperator:
  serviceMonitor:
    selfMonitor: false
